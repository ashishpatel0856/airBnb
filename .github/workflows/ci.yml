name: Spring Boot CI - Java 17 (Production Grade)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-test:
    name: üß™ Build & Test
    runs-on: ubuntu-latest

    strategy:
      matrix:
        java-version: [17]

    steps:
      # 1Ô∏è‚É£ Checkout Code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Set Up Java Environment
      - name: Set up JDK ${{ matrix.java-version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java-version }}
          distribution: temurin
          cache: maven

      # 3Ô∏è‚É£ Verify Java & Maven
      - name: Verify versions
        run: |
          java -version
          mvn -version

      # 4Ô∏è‚É£ Build and Run Tests (with H2 test profile)
      - name: Build and Run Tests
        env:
          SPRING_PROFILES_ACTIVE: test
        run: mvn clean verify -B -V

      # 5Ô∏è‚É£ Upload Build Artifact (JAR)
      - name: Upload JAR Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: spring-boot-app
          path: target/*.jar

  # üßπ OPTIONAL: Code Quality Job (runs in parallel)
  quality:
    name: üß© Code Quality Check
    runs-on: ubuntu-latest
    needs: build-test
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: temurin
          cache: maven

      - name: Run Checkstyle
        run: mvn checkstyle:check || true

      - name: Run Code Coverage (JaCoCo)
        run: mvn jacoco:report

      - name: Upload Code Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: target/site/jacoco

  # üöÄ OPTIONAL: Deployment (only from main branch)
  deploy:
    name: üöÄ Deploy to Production
    runs-on: ubuntu-latest
    needs: build-test
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: temurin

      - name: Deploy to Server (SSH or Render/Heroku)
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          echo "üöÄ Deploying Spring Boot JAR..."
          # Example (Render or EC2)
          # scp -i key.pem target/app.jar ubuntu@<SERVER_IP>:/home/ubuntu/app/
          # ssh -i key.pem ubuntu@<SERVER_IP> "nohup java -jar /home/ubuntu/app/app.jar &"
